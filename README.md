# Creation-of-an-addition-to-the-database-focused-on-interaction-with-the-PostgreSQL-DBMS

Консольна програма для демонстрації:

- роботи з реляційною БД (PostgreSQL);
- CRUD-операцій над сутностями `Users / Books / Activity / Book_Impressions`;
- **пошукових запитів із фільтрами та групуванням** по кількох таблицях;
- **вимірювання часу виконання запитів** (у мілісекундах);
- **демонстрації FK-помилок з боку СУБД**.

Особливість:  
У всіх сценаріях взаємодії з користувачем **не вводяться ID**, вибір сутностей відбувається за “людськими” атрибутами (імʼя, логін, назва книги, автор, жанр). ID використовуються тільки всередині програми / БД і не вимагаються від користувача.  
Є один спеціальний пункт-демо для FK-помилок (але навіть там вибір йде через ім’я/назву, а не ID).

---

## 1. Технології

- **Python** 3.10+ (рекомендовано)
- **PostgreSQL** 13+ (але має працювати й на новіших)
- **psycopg** 3.x (нове покоління драйвера)
- **python-dotenv** (для зручного завантаження `DATABASE_URL` з `.env`)

---

## 2. Структура проєкту

```text
project/
├─ app.py          # Вхідна точка програми
├─ controller.py   # Логіка меню, взаємодія Model <-> View
├─ model.py        # Доступ до БД, SQL-запити
├─ view.py         # Консольний інтерфейс (меню, введення/виведення)
└─ README.md       # Опис (цей файл)

3. Підготовка оточення
3.1. Встановити залежності
pip install psycopg[binary] python-dotenv
psycopg[binary] зручно використовувати для швидкого старту (вбудовані бінарники).
3.2. Налаштувати PostgreSQL
1.	Створити БД, наприклад:
 	createdb library_demo
2.	Користувач PostgreSQL має мати права на підключення та створення таблиць у цій БД.
3.3. Налаштувати .env
У корені проєкту створити файл .env:
DATABASE_URL=postgresql://username:password@localhost:5432/library_demo
Пояснення:
•	username / password — облікові дані PostgreSQL;
•	localhost / 5432 — хост і порт БД;
•	library_demo — назва створеної БД.
Програма читає це значення в app.py через:
dsn = os.getenv("DATABASE_URL")

4. Запуск
У корені проєкту:
python app.py
Якщо:
•	DATABASE_URL коректний;
•	PostgreSQL доступний;
програма:
1.	перевірить підключення (Model.ping()),
2.	викличе model.ensure_schema() (перевірка / створення схеми),
3.	покаже в консолі:
 	textКопировать код[ІНФО] Схему перевірено/підготовлено. ОК.
[ІНФО] Підключення до БД — OK.
=== Головне меню ===
...
Примітка: реалізація ensure_schema() знаходиться в model.py і створює всі необхідні таблиці, якщо їх ще нема.

5. Модель даних
5.1. Сутності
1.	User (public."user")
–	user_id — PK, цілочисельний
–	full_name — повне імʼя
–	username — логін (унікальний)
–	tg_handle — Telegram handle або NULL
–	created_at — час створення
2.	Book (public.books)
–	book_id — PK
–	title — назва
–	author — автор
–	genre — жанр
–	created_at — час створення
3.	Activity (public.activity)
–	user_id — FK → user(user_id)
–	book_id — FK → books(book_id)
–	PK — комбінований (user_id, book_id)
–	(фіксує сам факт взаємодії користувача з книгою)
4.	Book_Impressions (public.book_impressions)
–	rating_id — PK
–	user_id — FK → user(user_id) (і часто ще FK → activity(user_id, book_id))
–	book_id — FK → books(book_id)
–	rating — оцінка (0.0–5.0, крок 0.1)
–	comment — текстовий коментар, може бути NULL
–	created_at — час створення
У коді час часто форматують через to_char(... AT TIME ZONE 'Europe/Kiev', ...), щоб гарно показувати в консолі.

6. Інтерактивна логіка (без введення ID)
6.1. Головне меню
=== Головне меню ===
1) CRUD: Users
2) CRUD: Books
3) CRUD: Activity (user_id, book_id)
4) CRUD: Book_Impressions
5) Генерація даних
6) Пошуки (мультикритерій/агрегації) + час виконання
0) Вихід
Усі підменю реалізовані в view.py (submenu_*), логіка обробки — в controller.py.
6.2. Users (CRUD: Users)
•	Перегляд (1) — показ перших 50 користувачів.
•	Додати (2) — вводимо:
–	Повне ім'я
–	Логін
–	TG (можна пропустити)
•	Оновити (3) — не вводимо ID:
a.	програма запитує шаблони для пошуку:
•	Шаблон повного імені (LIKE)
•	Шаблон логіна (LIKE)
b.	по результатах показує список,
c.	користувач вибирає номер,
d.	далі змінює поля з підстановкою старих значень.
•	Видалити (4) — аналогічно: спочатку інтерактивний вибір користувача → перевірка залежних activity та book_impressions → підтвердження → видалення.
Усе це будується на:
•	Model.users_search_simple(...)
•	View.choose_from_rows(...)
•	допоміжному методі в Controller: _select_user_interactive().
6.3. Books (CRUD: Books)
Повністю аналогічно до Users:
•	пошук по title/author/genre через LIKE;
•	інтерактивний вибір книги;
•	оновлення / видалення без ручного введення book_id.
Основні методи:
•	Model.books_search_simple(...)
•	Controller._select_book_interactive()

6.4. Activity (CRUD: Activity)
Activity — це звʼязка User × Book.
•	Перегляд (1) — показує список усіх записів:
–	користувач (username, full_name),
–	книга (title, author, genre).
•	Додати (2) — без ID:
a.	обрати користувача (_select_user_interactive)
b.	обрати книгу (_select_book_interactive)
c.	програма виконає Model.activity_create(user_id, book_id) з ON CONFLICT DO NOTHING
→ якщо пара вже існує — користувач побачить повідомлення.
•	Оновлення (3) — відключено:
PK — пара (user_id, book_id), тому пропонується видалити й створити заново.
•	Видалити (4):
a.	обрати користувача;
b.	обрати одну з його книг із Activity (Model.activity_for_user);
c.	показати попередження, якщо є залежні записи в book_impressions;
d.	підтвердження та видалення.
6.5. Book_Impressions (CRUD: Book_Impressions)
Підменю:
--- Book_Impressions ---
1) Перегляд (перші 50)
2) Додати (З ПЕРЕВІРКОЮ activity)
3) Оновити
4) Видалити
5) Додати БЕЗ перевірки (ДЕМО FK-помилки з боку СУБД)
0) Назад
6.5.1. Перегляд (1)
Показує останні 50 вражень з приєднаними користувачами та книгами.
6.5.2. Додати (2) — із перевіркою Activity
1.	Обрати користувача (через _select_user_interactive).
2.	Обрати книгу з його Activity (Model.activity_for_user).
3.	Ввести оцінку та коментар.
4.	Вставка через Model.impressions_create(...).
Таким чином, створити враження можна тільки для пари, яка існує в Activity.
6.5.3. Оновити (3)
1.	Обрати користувача.
2.	Обрати конкретний відгук (Model.impressions_for_user + choose_from_rows).
3.	Змінити оцінку / коментар.
6.5.4. Видалити (4)
Аналогічно до оновлення:
1.	обрати користувача;
2.	обрати відгук;
3.	підтвердити видалення.
6.6. DEMO: Додати БЕЗ перевірки (5) — FK-помилка з боку СУБД
Суть цього пункту — показати, що:
•	програма не робить попередню перевірку (ніякого activity_exists);
•	при вставці може спрацювати FOREIGN KEY у БД, і помилку перехопить код на рівні Controller.run().
Сценарій:
1.	У головному меню:
4) CRUD: Book_Impressions → 5) Додати БЕЗ перевірки (ДЕМО FK-помилки з боку СУБД)
2.	Програма:
–	просить обрати користувача (по full_name / username);
–	просить обрати будь-яку книгу (по назві / автору / жанру) — не обовʼязково з його Activity;
–	просить ввести оцінку й коментар;
–	викликає Model.impressions_create(user_id, book_id, ...) без будь-яких попередніх перевірок.
3.	Якщо в схемі БД є FK типу:
 	sqlКопировать кодFOREIGN KEY (user_id, book_id)
    REFERENCES public.activity(user_id, book_id)
 	і така пара в activity не існує, Postgres кине ForeignKeyViolation,
яку верхній рівень (Controller.run) перехопить і покаже повідомлення:
 	[ПОМИЛКА] Порушення зовнішнього ключа (FK). Операцію скасовано. (SQLSTATE=...)
Це якраз демонстрація роботи СУБД, а не ручної валідації в коді.
7. Генерація даних
Меню:
--- Генерація ---
1) Users (N)
2) Books (N)
3) Activity (унікальні пари user×book)
4) Book_Impressions (із наявних Activity)
5) Конвеєр 1→2→3→4
0) Назад
7.1. Users (1)
Model.generate_users(n):
•	додає n користувачів із згенерованими full_name / username / tg_handle;
•	дати створення — випадкові в межах останнього року.
7.2. Books (2)
Model.generate_books(n):
•	генерує назви на основі масивів прикметників/іменників;
•	авторів (імʼя + прізвище);
•	жанри з обмеженого списку (fantasy, sci-fi, ...).
7.3. Activity (3)
Model.generate_activity(n):
•	випадково обирає унікальні пари user×book;
•	якщо вільних пар менше, ніж n, видає помилку.
7.4. Book_Impressions (4)
Model.generate_impressions(n):
•	обирає випадкові пари з activity,
•	генерує оцінки (1.0–5.0, крок 0.1) і прості коментарі.
7.5. Конвеєр (5)
Users(n) → Books(n) → Activity(max(n,1)) → Book_Impressions(max(n//2,1))
Зручно для швидкого наповнення БД перед тестуванням пошукових запитів.
8. Пошуки + час виконання
Меню:
--- Пошуки ---
1) Мультикритерій: title/author/genre (LIKE) + rating(range) + дати + has_tg
2) Агрегація: середні оцінки по author/genre у вікні дат (мін. кількість)
3) Користувачі без TG, що взаємодіяли з жанром у вікні дат
0) Назад
Усі пошуки виконуються через метод Controller.timed(fn, *args):
•	міряється час time.perf_counter() до/після виконання SQL;
•	результат + час у мілісекундах виводяться на екран:
textКопировать кодЧас: 12.3 мс
8.1. Пошук 1: search_multientity
Фільтри:
•	title/author/genre — LIKE (з ILIKE в SQL, регістронезалежно);
•	rating_min / rating_max — діапазон оцінок;
•	date_from / date_to — фільтр по даті створення враження;
•	has_tg — тільки з TG / тільки без TG / байдуже.
JOIN-и:
•	book_impressions + user + books.
8.2. Пошук 2: search_aggregate_ratings
Агрегує оцінки:
•	групування по author або genre (користувач обирає рядком);
•	фільтр по даті;
•	HAVING COUNT(*) >= min_count.
Результат:
{'grp': 'Some Author', 'cnt': 123, 'avg_rating': Decimal('4.27')}
Сортування: від більшої оцінки до меншої, потім за кількістю.
8.3. Пошук 3: search_users_no_tg_by_genre
Шукає користувачів БЕЗ Telegram, які:
•	взаємодіяли (через activity + book_impressions) із зазначеним жанром (LIKE по b.genre);
•	в заданому вікні дат.
JOIN:
•	activity + user + books + book_impressions.
Результат: список унікальних користувачів.

9. Типові сценарії використання
1.	Підготувати БД:
Запустити програму — ensure_schema створить таблиці, якщо їх ще немає.
2.	Згенерувати дані:
–	у головному меню → 5) Генерація даних
–	послідовно виконати:
•	1) Users (N)
•	2) Books (N)
•	3) Activity
•	4) Book_Impressions
•	або одразу 5) Конвеєр 1→2→3→4.
3.	Погратися з CRUD:
–	створення / оновлення / видалення Users/Books/Activity/Impressions без введення ID — все через пошук і вибір зі списку.
4.	Перевірити пошуки та час виконання:
–	в меню → 6) Пошуки...
–	запускати різні варіанти фільтрів і дивитися на час (мс).
5.	Подивитись FK-помилку з боку СУБД:
–	створити користувача і книгу, для яких нема відповідного activity;
–	в меню Book_Impressions вибрати 5) Додати БЕЗ перевірки...;
–	обрати цього користувача й книгу;
–	при вставці СУБД кине помилку FOREIGN KEY, яку програма перехопить і покаже в консоль.

10. Обробка помилок
У Controller.run() є перехоплення основних помилок:
•	ForeignKeyViolation — порушення FK (демо-сценарій і не тільки);
•	UniqueViolation — порушення унікальності (username, tg_handle, title тощо);
•	інші psycopg.Error — загальні помилки БД;
•	Exception — непередбачені помилки.
Усі повідомлення виводяться в консоль через View.err(...) у зрозумілому для користувача форматі.

